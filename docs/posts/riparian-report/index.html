<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Liam Smith">
<meta name="dcterms.date" content="2023-04-18">
<meta name="description" content="Identifying priority parcels for flood hazard and conservation buy-out programs.">

<title>Liam Smith - Flood Risk and Conservation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #f2f2f2;
      }

      .quarto-title-block .quarto-title-banner {
        color: #f2f2f2;
background-image: url(../../img/panorama5.jpg);
background-size: cover;
      }
</style>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Liam Smith</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../portfolio.html"> 
<span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Liam-W-Smith"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/liam-smith-b159791b3/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Flood Risk and Conservation</h1>
                  <div>
        <div class="description">
          Identifying priority parcels for flood hazard and conservation buy-out programs.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Conservation</div>
                <div class="quarto-category">Google Earth Engine</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Liam Smith </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 18, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Through the Flood Resilient Communities Fund (FRCF), the Vermont legislature has allocated $14,750,000 of American Rescue Plan Act funds for projects that reduce flood risk and promote community resilience for the fiscal year 2023 (VT DEC Watershed Management Division &amp; VT Emergency Management, 2022). Focused on “buyouts of flood-vulnerable properties,” this funding presents communities throughout Vermont, including the Town of Middlebury, with an opportunity to mitigate local flood hazards by purchasing parcels that are particularly prone to flooding or valuable for floodwater storage (VT DEC Watershed Management Division &amp; VT Emergency Management, 2022).</p>
<p>Furthermore, by evaluating the overlap between flood-prone areas and priority conservation targets, communities may be able to realize conservation co-benefits by prioritizing purchasing parcels that are both at risk of flooding and home to wildlife habitats. In this analysis, I present one methodology for identifying priority parcels in Middlebury for buyout under FRCF, and I investigate the sensitivity of this methodology to the choice of input layers.</p>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>Vermont Conservation Design (VCD) is a governmental initiative that takes a “rigorous, science-based” approach to conservation efforts (Sorenson &amp; Zaino, 2018). By developing statewide datasets of forest blocks, riparian areas, natural communities, wetlands, and more, VCD provides the data required to conduct informed and targeted conservation efforts (Sorenson &amp; Zaino, 2018). Furthermore, through the online BioFinder mapping interface, the Vermont Agency of Natural Resources (ANR) provides ordinary citizens with the opportunity to explore these datasets (Creating BioFinder and Vermont Conservation Design, n.d.).</p>
<p>Two layers that are made publicly available through VCD are a “Surface Water and Riparian Areas - Highest Priority” layer, which includes all aquatic habitats in Vermont and the valley bottoms typically affected by flooding, and a “Riparian Wildlife Connectivity” layer, which includes riparian areas and habitat corridors for riparian wildlife (VT ANR Biofinder/VCD Team, 2019). The intersection of these two layers would provide us with the locations that are both flood-prone and important for riparian wildlife, which are precisely the conditions that we seek for identifying parcels for buyout under FRCF.</p>
<p>Unfortunately, the VCD layers have a relatively coarse spatial resolution. As evidence of this, please see the figure on the following page, which shows a close-up look at the “Riparian Wildlife Connectivity” layer (Figure 1). Notice the pixelation and how parts of Otter Creek fail to be included in the layer; in reality, riparian wildlife certainly use the entire creek. While VCD’s layers provide valuable information at scale, datasets of finer spatial resolution may provide more reliable information when developing buy-out recommendations.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig1.png" class="img-fluid figure-img"></p>
<figcaption>Figure 1: A close-up look at VCD’s “Riparian Wildlife Connectivity” layer in Middlebury.</figcaption>
</figure>
</div>
<p>According to Avelino et al., high resolution imagery can capture more detail but it can also introduce more noise, so the choice of spatial resolution should be specific to one’s use of the imagery (Avelino et al., 2016). In this analysis, I develop a higher resolution alternative to VCD’s layers, using a number of high-resolution layers introduced to us by Professor Howarth. To both layers, I apply a methodology for identifying properties for buy-out – calculating the percentage of each parcel in a desirable location for riparian conservation – in the hopes that I might determine which resolution is preferable for our purposes.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>First, I identified locations that are both at risk of flooding and valuable for conservation efforts according to VCD by taking the intersection of VCD’s “Surface Water and Riparian Areas - Highest Priority” and “Riparian Wildlife Connectivity” layers.</p>
<p>To create a higher resolution alternative to this layer, I first created higher resolution alternatives to the two input layers. Specifically, as a replacement for VCD’s surface waters layer, I took the union of the ANR river corridors and small stream setbacks, Addison County’s wetlands, and Middlebury’s FEMA flood hazard areas. As an alternative to VCD’s riparian wildlife connectivity layer, I took the union of all water and tree cover landcover in Middlebury. Many thanks to Professor Howarth for putting together several of these layers in Earth Engine. Finally, I took the intersection of these two layers to serve as a higher resolution alternative to the intersection of the two VCD layers. The figure below illustrates the similarities and differences between the two layers (Figure 2). Notably, the VCD layer is far more pixelated and tends to include wider buffers around Otter Creek, Middlebury River, and the Muddy Branch, while the high-resolution alternative includes more wetlands and flood-prone regions not directly adjacent to rivers.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig2.png" class="img-fluid figure-img"></p>
<figcaption>Figure 2: Priority lands to help identify parcels to buy-out for flooding and conservation reasons.</figcaption>
</figure>
</div>
<p>Next, I used a reducer to calculate the area of each of the two layers within each parcel in Middlebury. I used this statistic to calculate the percentage of each parcel’s area that is overlapped by the two different layers. All of that analysis is available <a href="https://code.earthengine.google.com/2fec03fecb991082a9434c911b77caec">in this script</a>.</p>
<p>Finally, I created a new script to produce the figures for my discussion. Specifically, I created a histogram and a choropleth map of the percentage of each parcel in a favorable location for riparian conservation for both the VCD layer and the high-resolution alternative. I also set a cut-off threshold of 80% and used that to generate an agreement and disagreement map of which parcels ought to be prioritized for buy-out under the two methodologies. This visualization script is <a href="https://code.earthengine.google.com/48e5e4a7f6bb485a41f496ae9d23decb">available here</a>, and the resulting figures are included below.</p>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>Although Figure 2 illustrates that the two methodologies for identifying priority lands for buy-out lead to substantially different layers, when we aggregate these layers to the parcel level, we find surprisingly similar results. To begin, let us evaluate the distribution of the percent area in each case.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig3.png" class="img-fluid figure-img"></p>
<figcaption>Figure 3: Frequency histogram of the percent area of parcels in VCD priority buy-out layer.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig4.png" class="img-fluid figure-img"></p>
<figcaption>Figure 4: Frequency histogram of percent area of parcels in the high-resolution buy-out layer.</figcaption>
</figure>
</div>
<p>Clearly, the distribution of parcels is fairly similar for the two methodologies. In both cases, the histogram is skewed right, with the vast majority of parcels having between 0% and 25% of their area in a desirable location for riparian conservation. There appear to be more parcels in the 25-50% category in the high-resolution layer, but fewer parcels in the 50-75% and 75-100% categories (Figures 3 and 4). While there is relatively little variation between the histograms, these graphs reveal nothing about any differences in spatial patterns between the two methodologies. To investigate any spatial differences, I created a choropleth map for each methodology (Figures 5 and 6).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig5.png" class="img-fluid figure-img"></p>
<figcaption>Figure 5: The percentage of each parcel’s land area in the VCD priority buy-out layer.</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig6.png" class="img-fluid figure-img"></p>
<figcaption>Figure 6: The percentage of each parcel’s land area in the high-resolution priority buy-out layer.</figcaption>
</figure>
</div>
<p>For the most part, these maps reveal similar spatial patterns for the two methodologies. In both maps, parcels in the vicinity of Otter Creek, the Middlebury River, and the Muddy Branch tend to be colored in deeper red, indicating that they are the most valuable parcels for riparian conservation (Figures 5 and 6). This trend is slightly more pronounced in the VCD map, with more parcels colored deep red around the rivers (Figure 5). This makes sense given the tendency of the VCD layer to include wider buffers around the rivers, which we noticed earlier in the comparison map of priority lands for buyout (Figure 2).</p>
<p>However, the higher resolution layer appears to have better captured the actual shape of the Middlebury River (Figure 6), perhaps because smaller pixels better capture the shapes of smaller features (Avelino et al., 2016). Additionally, further away from the rivers, there appears to be more white parcels in the VCD map (Figures 5 and 6). This may occur because the high-resolution layer includes more wetlands and flood-prone areas away from the rivers, as noted in the comparison map earlier (Figure 2).</p>
<p>As one might expect, these tendencies carried over to the classification of parcels for prioritization for buyout. As mentioned in the methodology section, I used a threshold of 80% to indicate whether one should prioritize a parcel for buyout. The choice of threshold was totally arbitrary and should be carefully evaluated if one were to actually use this method to propose the buyout of parcels under the FRCF.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="assets/fig7.png" class="img-fluid figure-img"></p>
<figcaption>Figure 7: Agreement and disagreement map regarding parcels to be prioritized for buyout.</figcaption>
</figure>
</div>
<p>As we expect from the choropleth maps (Figures 5 and 6), both methodologies indicate that several properties in the vicinity of Otter Creek, the Middlebury River, and the Muddy Branch ought to be prioritized for conservation (Figure 7). The VCD methodology includes a few additional parcels in the vicinity of Otter Creek, while the high-resolution methodology better captures the Middlebury River (Figure 7).</p>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>Overall, the results for the VCD and high-resolution methodologies were very similar. The high-resolution layer may represent a slight improvement because it better captures the habitat and flood-prone areas that are not situated in the vicinity of rivers. On the other hand, the VCD layer produced largely similar results, using far less computational effort due to the reduced number of pixels, so it may suffice for an analyst concerned about computational speed.</p>
<p>There are a couple of areas of weakness to my analysis that future work ought to address. First of all, the method I used to isolate the parcels in the Town of Middlebury also included any parcels bordering Middlebury. Although I clip these parcels out in the final figures, it would be computationally more efficient not to calculate percent area for these parcels at all. There are also a few cases where a parcel’s percent area is calculated to be slightly more than 100%. At 100.1% or 100.2%, I suspect this occurred because some raster cells were split over the boundary of the parcel, but this would certainly be worthwhile to investigate.</p>
<p>Additionally, while I used several of the layers presented in class, there are others that could provide additional insight, such as the grassland habitat blocks. Future work ought to refine the high-resolution layer to be as comprehensive yet noise-free as possible. Finally, further work should actually make recommendations for parcels to buy-out under FRCF. To make legitimate recommendations, one might use a methodology similar to the one in this report, and then cross-reference the high-priority parcels with information regarding the current land use and ownership of those parcels. Overall, this work provides a solid basis for identifying parcels to buy-out under FRCF, but there is substantial additional work that would be required to actually make those recommendations.</p>
</section>
<section id="bibliography" class="level2">
<h2 class="anchored" data-anchor-id="bibliography">Bibliography</h2>
<p>Avelino, A. F. T., Baylis, K., &amp; Honey-Rosés, J. (2016). Goldilocks and the Raster Grid: Selecting Scale when Evaluating Conservation Programs. PLOS ONE, 11(12), e0167945. https://doi.org/10.1371/journal.pone.0167945</p>
<p>Creating BioFinder and Vermont Conservation Design. (n.d.). VT Agency of Natural Resources. Retrieved April 17, 2023, from https://anr.vermont.gov/maps/biofinder/creating-and- design</p>
<p>Sorenson, E., &amp; Zaino, R. (2018). Summary Report for Landscapes, Natural Communities, Habitats, and Species. Vermont Conservation Design. https://anr.vermont.gov/sites/anr/files/maps/biofinder/Vermont%20Conservation%20Desi gn%20-%20Summary%20Report%20-%20February%202018.pdf</p>
<p>VT ANR Biofinder/VCD Team. (2019). BioFinder 3.0 Development Report. https://drive.google.com/file/d/1eiLfinDcBmC4skrvpNl3RVbkdLxSHzfj/view</p>
<p>VT DEC Watershed Management Division &amp; Vermont Emergency Management. (2022). Flood Resilient Communities Fund Program Overview – August 2022. https://vem.vermont.gov/sites/demhs/files/documents/Flood%20Resilient%20Communiti es%20Fund%20Overview_FY23.pdf</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>